<div class="card mb-0">
  <h3 class="mb-16px c-black">
    <%= @period %> <%= region_type %> performance
  </h3>
  <div class="table-responsive">
    <table id="region-comparison-table" class="table-compact">
      <colgroup>
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
      </colgroup>
      <thead>
        <tr>
          <th></th>
          <th colspan="2">
            BP controlled
            <%= render "definition_tooltip",
                    definitions: { "Numerator" => t("bp_controlled_copy.numerator"),
                                  "Denominator" => t("denominator_excluding_ltfu_copy", region_name: @region.name) }
            %>
          </th>
          <th colspan="2">
            BP not controlled
            <%= render "definition_tooltip",
                    definitions: { "Numerator" => t("bp_not_controlled_copy.numerator"),
                                  "Denominator" => t("denominator_excluding_ltfu_copy", region_name: @region.name) }
            %>
          </th>
          <th colspan="2">
            Missed visits
            <%= render "definition_tooltip",
                    definitions: { "Numerator" => t("missed_visits_copy.numerator"),
                                  "Denominator" => t("denominator_excluding_ltfu_copy", region_name: @region.name) }
            %>
          </th>
          <th colspan="2">
            Registrations
            <%= render "definition_tooltip",
                      definitions: {
                        "Total registered patients" => t("registered_patients_copy.total_registered_patients", region_name: @region.name),
                        "Monthly registered patients" => t("registered_patients_copy.monthly_registered_patients", region_name: @region.name)
                      }
            %>
          </th>
        </tr>
        <tr class="sorts" data-sort-method="thead">
          <th class="row-label sort-label sort-label-small ta-left" data-sort-default>
            <%= region_type.capitalize %>
          </th>
          <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
            Percent
          </th>
          <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
            Total patients
          </th>
          <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
            Percent
          </th>
          <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
            Total patients
          </th>
          <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
            Percent
          </th>
          <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
            Total patients
          </th>
          <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
            Total
          </th>
          <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number">
            <%= @period.to_s %>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr class="row-total" data-sort-method="none">
          <td class="type-title">
            <%= @region.name %>
          </td>
          <td
            class="type-percent"
            data-sort-column-key="bp-controlled-rate"
            data-sort="<%= @data.last_value(:controlled_patients_rate) %>"
            data-toggle="tooltip"
            title="<%= number_with_delimiter(@data.last_value(:controlled_patients)) %> / <%= number_with_delimiter(@data.last_value(:adjusted_registrations)) %> patients"
          >
            <em data-rate="<%= @data.last_value(:controlled_patients_rate) %>">
              <%= number_to_percentage(@data.last_value(:controlled_patients_rate), precision: 0) %>
            </em>
          </td>
          <td class="ta-left">
            <%= number_with_delimiter(@data.last_value(:controlled_patients)) %>
          </td>
          <td
            class="type-percent"
            data-sort-column-key="bp-not-controlled-rate"
            data-sort="<%= @data.last_value(:uncontrolled_patients_rate) %>"
            data-toggle="tooltip"
            title="<%= number_with_delimiter(@data.last_value(:uncontrolled_patients)) %> / <%= number_with_delimiter(@data.last_value(:adjusted_registrations)) %> patients"
          >
            <em data-rate="<%= @data.last_value(:uncontrolled_patients_rate) %>">
              <%= number_to_percentage(@data.last_value(:uncontrolled_patients_rate), precision: 0) %>
            </em>
          </td>
          <td class="ta-left">
            <%= number_with_delimiter(@data.last_value(:uncontrolled_patients)) %>
          </td>
          <td
            class="type-percent"
            data-sort-column-key="missed-visits-rate"
            data-sort="<%= @data.last_value(:missed_visits_rate) %>"
            data-toggle="tooltip"
            title="<%= number_with_delimiter(@data.last_value(:missed_visits)) %> / <%= number_with_delimiter(@data.last_value(:adjusted_registrations)) %> patients"
          >
            <em data-rate="<%= @data.last_value(:missed_visits_rate) %>">
              <%= number_to_percentage(@data.last_value(:missed_visits_rate), precision: 0) %>
            </em>
          </td>
          <td class="ta-left">
            <%= number_with_delimiter(@data.last_value(:missed_visits)) %>
          </td>
          <td class="ta-left">
            <%= number_with_delimiter(@data.last_value(:cumulative_registrations)) %>
          </td>
          <td class="ta-left">
            <%= number_with_delimiter(@data.last_value(:registrations)) %>
          </td>
        </tr>
        <% data.each do |result| %>
          <% next if result.dig("controlled_patients_rate", @period).nil? %>
          <% next if result.dig("uncontrolled_patients_rate", @period).nil? %>
          <% next if result.dig("missed_visits_rate", @period).nil? %>
          <% next if result.dig("registrations", @period).nil? %>
          <tr>
            <td class="ta-left">
              <%= link_to(reports_region_path(result.region, report_scope: region_type)) do %>
                <%= result.region.name %>
              <% end %>
            </td>
            <td
              class="type-percent"
              data-sort-column-key="bp-controlled-rate"
              data-sort="<%= result["controlled_patients_rate"].values.last %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result["controlled_patients"].values.last) %> / <%= number_with_delimiter(result["adjusted_registrations"].values.last) %> patients"
            >
              <em data-rate="<%= result["controlled_patients_rate"].values.last %>">
                <%= number_to_percentage(result["controlled_patients_rate"].values.last || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result["controlled_patients"].values.last) %>
            </td>
            <td
              class="type-percent"
              data-sort-column-key="bp-not-controlled-rate"
              data-sort="<%= result["uncontrolled_patients_rate"].values.last %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result["uncontrolled_patients"].values.last) %> / <%= number_with_delimiter(result["adjusted_registrations"].values.last) %> patients"
            >
              <em data-rate="<%= result["uncontrolled_patients_rate"].values.last %>">
                <%= number_to_percentage(result["uncontrolled_patients_rate"].values.last || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result["uncontrolled_patients"].values.last) %>
            </td>
            <td
              class="type-percent"
              data-sort-column-key="missed-vists-rate"
              data-sort="<%= result["missed_visits_rate"].values.last %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result["missed_visits"].values.last) %> / <%= number_with_delimiter(result["adjusted_registrations"].values.last) %> patients"
            >
              <em data-rate="<%= result["missed_visits_rate"].values.last %>">
                <%= number_to_percentage(result["missed_visits_rate"].values.last || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result["missed_visits"].values.last) %>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result["cumulative_registrations"].values.last) %>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result["registrations"].values.last || 0) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>