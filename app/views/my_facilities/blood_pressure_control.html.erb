<div class="row">
  <div class="col-lg-12">
    <div class="card card-responsive">
      <div>
        <div>
          <div class="d-flex align-baseline jc-between">
            <h3>
              BP controlled
            </h3>
            <p class="c-grey-dark">
              Last updated: <%= @last_updated_at %>
            </p>
          </div>
          <p>
            <strong>What to look for:</strong> High percentages are good, and 70% or higher is ideal
          </p>
        </div>
        <div class="d-flex fw-wrap">
          <%= render "shared/size_and_zone_filters" %>
        </div>
      </div>
      <table class="mt-5 table table-compact table-responsive-md table-hover analytics-table">
        <colgroup>
          <col>
          <col class="table-divider">
          <col>
          <col class="table-divider">
          <col>
          <col class="table-divider">
          <col>
          <col class="table-divider">
          <col>
          <col class="table-divider">
          <col class="mobile">
        </colgroup>
        <thead>
          <tr>
            <th></th>
            <th colspan="6">
              Cohort of patients registered in <%= registration_period %>
            </th>
            <th colspan="3">
              Overall BP control<sup>1</sup>
            </th>
            <th class="mobile"></th>
          </tr>
          <tr data-sort-method="thead" class="sorts">
            <th class="row-label sort-label">
              Facilities
            </th>
            <th class="row-label sort-label" data-sort-method="number" data-sort-column-key="controlled" colspan="2" data-sort-default>
              Controlled BP<br>
              in <%= visited_in_period %>
            </th>
            <th class="row-label sort-label" data-sort-method="number" data-sort-column-key="uncontrolled" colspan="2">
              Uncontrolled BP<br>
              in <%= visited_in_period %>
            </th>
            <th class="row-label sort-label" data-sort-method="number" data-sort-column-key="missed" colspan="2">
              No BP taken
              <br>in <%= visited_in_period %>
            </th>
            <th class="row-label sort-label" data-sort-method="number" data-sort-column-key="overall-percent" colspan="2">
              Controlled BP<br>in last 90 days
            </th>
            <th class="row-label sort-label" data-sort-method="number" data-sort-column-key="overall-patients">
              Total patients
            </th>
            <th class="mobile"></th>
          </tr>
        </thead>
        <tbody>
          <tr class="row-total" data-sort-method="none">
            <td class="type-title">
              All
            </td>
            <td class="type-percent">
              <em><%= percentage(@totals[:controlled], @totals[:cohort_patients]) %></em>
            </td>
            <td class="type-number">
              <%= number_or_dash_with_delimiter(@totals[:controlled]) %>
            </td>
            <td class="type-percent">
              <em><%= percentage(@totals[:uncontrolled], @totals[:cohort_patients]) %></em>
            </td>
            <td class="type-number">
              <%= number_or_dash_with_delimiter(@totals[:uncontrolled]) %>
            </td>
            <td class="type-percent">
              <em><%= percentage(@totals[:missed], @totals[:cohort_patients]) %></em>
            </td>
            <td class="type-number">
              <%= number_or_dash_with_delimiter(@totals[:missed]) %>
            </td>
            <td class="type-percent">
              <em><%= percentage(@totals[:overall_controlled_bps], @totals[:overall_patients]) %></em>
            </td>
            <td class="type-number">
              <%= number_or_dash_with_delimiter(@totals[:overall_controlled_bps]) %>
            </td>
            <td class="type-number">
              <%= number_or_dash_with_delimiter(@totals[:overall_patients]) %>
            </td>
          </tr>
          <% @facilities.each do |facility| %>
            <% bp_stats = { cohort_patients: @cohort_patients_per_facility[facility.id].to_i,
                            controlled: @controlled_bps_per_facility[facility.id].to_i,
                            uncontrolled: @uncontrolled_bps_per_facility[facility.id].to_i,
                            missed: @missed_visits_by_facility[facility.id].to_i,
                            overall_patients: @overall_patients_per_facility[facility.id].to_i,
                            overall_controlled_bps: @overall_controlled_bps_per_facility[facility.id].to_i } %>
            <tr>
              <td class="type-title">
                <%= link_to facility.name, reports_region_facility_path(facility) %>
              </td>
              <td class="type-percent" data-sort-column-key="controlled">
                <em><%= percentage(bp_stats[:controlled], bp_stats[:cohort_patients]) %></em>
              </td>
              <td class="type-number">
                <%= number_or_dash_with_delimiter(bp_stats[:controlled]) %>
              </td>
              <td class="type-percent" data-sort-column-key="uncontrolled">
                <em><%= percentage(bp_stats[:uncontrolled], bp_stats[:cohort_patients]) %></em>
              </td>
              <td class="type-number">
                <%= number_or_dash_with_delimiter(bp_stats[:uncontrolled]) %>
              </td>
              <td class="type-percent" data-sort-column-key="missed">
                <em><%= percentage(bp_stats[:missed], bp_stats[:cohort_patients]) %></em>
              </td>
              <td class="type-number">
                <%= number_or_dash_with_delimiter(bp_stats[:missed]) %>
              </td>
              <td class="type-percent" data-sort-column-key="overall-percent">
                <em><%= percentage(bp_stats[:overall_controlled_bps], bp_stats[:overall_patients]) %></em>
              </td>
              <td class="type-number" data-sort-column-key="overall-controlled">
                <%= number_or_dash_with_delimiter(bp_stats[:overall_controlled_bps]) %>
              </td>
              <td class="type-number" data-sort-column-key="overall-patients">
                <%= number_or_dash_with_delimiter(bp_stats[:overall_patients]) %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <section class="footnotes">
      <ol>
        <li>
          <strong>Overall BP control:</strong>
        </li>
          <ul>
            <li>
              Numerator: Patients whose last BP in the past 90 days was &lt;140/90.
            </li>
            <li>
              Denominator: Patients with this preferred facility.
            </li>
            <li>
              Patients registered in the last 3 months are excluded from both the <i>Numerator</i> and <i>Denominator</i>.
            </li>
            <li>
              Note: Follow-up BPs may be recorded at any facility.
            </li>
          </ul>
      </ol>
    </section>
  </div>
</div>
